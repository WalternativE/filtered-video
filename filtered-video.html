<link rel="import" href="../paper-button/paper-button.html" />
<link rel="import" href="../paper-input/paper-input.html" />
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html" />

<link rel="import" href="../polymer/polymer.html" />

<!--
`filtered-video`
university exercise

@demo demo/index.html 
-->

<dom-module id="filtered-video">
  <style include="iron-flex">
    :host {
      display: block;
    }
  </style>

  <template>
    <div class="layout vertical">
      <paper-input label="Choose a video file" type="file" accept="video/*" on-change="handleInputChange"></paper-input>
      <video id="player" on-play="handlePlay" style="display: none"></video>
      <canvas id="backing" class="flex"></canvas>
      <canvas id="mirror" class="flex"></canvas>

      <div class="layout vertical">
        <div class="layout horizontal">
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
        </div>
        <div class="layout horizontal">
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
        </div>
        <div class="layout horizontal">
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
        </div>
        <div class="layout horizontal">
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
        </div>
        <div class="layout horizontal">
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
          <paper-input label="val"></paper-input>
        </div>
        <paper-input label="Scale"></paper-input>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'filtered-video',

      blaCounter: 0,

      handleTap: function() {
        console.log("Tap handel event!")
      },

      handleInputChange: function(event) {
        let file;
        if (event.srcElement) {
          file = event.srcElement.files[0];
        } else if (event.target) {
          file = event.target.files[0];
        }

        let objectURL = URL.createObjectURL(file);

        let source = document.createElement('source');
        source.src = objectURL;
        source.type = file.type;

        this.$.player.appendChild(source);
        this.$.player.play();
      },

      handlePlay: function() {
        console.log("play!");

        let video = this.$.player;

        let contextBacking = this.$.backing.getContext('2d');
        let widthBacking = this.$.backing.clientWidth;
        let heightBacking = this.$.backing.clientHeight;

        let _this = this;

        this.draw(this, video, contextBacking, widthBacking, heightBacking);
      },

      draw: function(localContext, video, context, width, height) {
          if(video.paused || video.ended) {
            console.log('video paused or ended');
            return false;
          }
          
          context.drawImage(video, 0, 0, width, height);

          // let rawImage = context.getImageData(0, 0, width, height);
          // let imageData = rawImage.data;

          // for(let i = 0; i <imageData.length; i += 4) {
          //   let r = imageData[i];
          //   let g = imageData[i+1];
          //   let b = imageData[i+2];
          //   let brightness = (3*r + 4*g + b) >>> 3;

          //   imageData[i] = brightness;
          //   imageData[i+1] = brightness;
          //   imageData[i+2] = brightness;
          // }
          // rawImage.data = imageData;

          // let contextMirror = localContext.$.mirror.getContext('2d');
          // contextMirror.putImageData(rawImage, 0, 0);

          localContext.applyFilter();

          setTimeout(localContext.draw, 20, localContext, video, context, width, height);
      },

      applyFilter: function() {        
        let sourceContext = this.$.backing.getContext('2d');
        let destinationContext = this.$.mirror.getContext('2d');

        let width = this.$.backing.clientWidth;
        let height = this.$.backing.clientHeight;

        let sourceImage = sourceContext.getImageData(0, 0, width, height);
        let destinationImage = sourceContext.getImageData(0, 0, width, height);

        let sourceData = sourceImage.data;
        let destinationData = destinationImage.data;

        let kernelOffset = 1;
        let kernelData  = [ [1 / 9, 1 / 9, 1 / 9],
                            [1 / 9, 1 / 9, 1 / 9],
                            [1 / 9, 1 / 9, 1 / 9] ];

        let outputBuffer = [];        

        for (let row = 0 + kernelOffset; row < height - 1 - kernelOffset; row++) {
          for (let column = 0 + kernelOffset; column < width - 1 - kernelOffset; column++) {

            for (let channel = 0; channel < 4; channel++) {

              let currentIndex = (row * width) + (column * 4) + channel;

              let oneUpIndex = currentIndex - (width * 4);
              let oneDownIndex = currentIndex + (width * 4);

              let indices = [oneUpIndex, currentIndex, oneDownIndex];

              let sum = 0;
              for (let i = 0; i < kernelData.length; i++) {

                let index = indices[i];

                for (let j = 0; j < kernelData[i].length; j++) {
                  sum += sourceData[index - 4] * kernelData[i][j];
                  console.log(sum);

                  sum += sourceData[index] * kernelData[i][j];
                  console.log(sum);

                  sum += sourceData[index + 4] * kernelData[i][j];
                  console.log(sum);

                  prompt();
                }

                outputBuffer.push(this.clip(sum));
              }
            }

          }
        }

        for (let i = 0 + kernelOffset; i < outputBuffer.length; i++) {
          destinationData[i] = outputBuffer[i];
        }

        destinationImage.data = destinationData;
        destinationContext.putImageData(destinationImage, 0, 0);
      },

      clip: function(value) {
        return Math.floor(Math.min(Math.max(value, 0), 255));
      }
    });
  </script>
</dom-module>